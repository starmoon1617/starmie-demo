<template>
    <v-menu v-model="show" :close-on-content-click="false" :return-value.sync="value" transition="scale-transition" offset-y>
        <template v-slot:activator="{ on, attrs }">
            <v-text-field height="30px" outlined dense :label="label" v-model="dateRangeText" readonly v-bind="attrs" v-on="on" hide-details class="pt-0 pb-1 searchForm" ></v-text-field>
        </template>
        <v-card>
            <v-card-text>
                <v-row>
                    <v-btn fab x-small class="ml-2" color="white" elevation="0" @click="yearMonthChange('year', -1)">
                        <v-icon>mdi-chevron-double-left</v-icon>
                    </v-btn>
                    <v-btn fab x-small class="ml-2" color="white" elevation="0" @click="yearMonthChange('month', -1)">
                        <v-icon>mdi-chevron-left</v-icon>
                    </v-btn>
                    <v-select append-icon="" v-model="year" :items="$getYears(2000)" menu-props="auto" class="px-2 searchForm" hide-details outlined dense height="34" style="width: 45px;" @change="yearChange"></v-select>
                    <v-select append-icon="" v-model="month" :items="$months" menu-props="auto" class="px-2 searchForm" hide-details outlined dense height="34" style="width: 65px;" @change="monthChange"></v-select>
                    <v-btn fab x-small class="mr-2" color="white" elevation="0" @click="yearMonthChange('month', 1)">
                        <v-icon>mdi-chevron-right</v-icon>
                    </v-btn>
                    <v-btn fab x-small class="mr-2" color="white" elevation="0" @click="yearMonthChange('year', 1)">
                        <v-icon>mdi-chevron-double-right</v-icon>
                    </v-btn>
                </v-row>
                <v-row>
                    <v-data-table dense :headers="dayHeaders" :items="days" class="elevation-0 datePicker" hide-default-footer >
                        <template v-slot:item.mon="{ item }">
                            <v-btn v-if="item.mon" fab x-small :color="(item.mon.selected?'blue lighten-3':(item.mon.current? 'blue lighten-5': 'white'))" elevation="0" @click="pickDate(item, 'mon')">{{ !item.mon.value ? '' : item.mon.value }}</v-btn>
                        </template>
                        <template v-slot:item.tue="{ item }">
                            <v-btn v-if="item.tue" fab x-small :color="(item.tue.selected?'blue lighten-3':(item.tue.current? 'blue lighten-5': 'white'))" elevation="0" @click="pickDate(item, 'tue')">{{ !item.tue.value ? '' : item.tue.value }}</v-btn>
                        </template>
                        <template v-slot:item.wed="{ item }">
                            <v-btn v-if="item.wed" fab x-small :color="(item.wed.selected?'blue lighten-3':(item.wed.current? 'blue lighten-5': 'white'))" elevation="0" @click="pickDate(item, 'wed')">{{ !item.wed.value ? '' : item.wed.value }}</v-btn>
                        </template>
                        <template v-slot:item.thu="{ item }">
                            <v-btn v-if="item.thu" fab x-small :color="(item.thu.selected?'blue lighten-3':(item.thu.current? 'blue lighten-5': 'white'))" elevation="0" @click="pickDate(item, 'thu')">{{ !item.thu.value ? '' : item.thu.value }}</v-btn>
                        </template>
                        <template v-slot:item.fri="{ item }">
                            <v-btn v-if="item.fri" fab x-small :color="(item.fri.selected?'blue lighten-3':(item.fri.current? 'blue lighten-5': 'white'))" elevation="0" @click="pickDate(item, 'fri')">{{ !item.fri.value ? '' : item.fri.value }}</v-btn>
                        </template>
                        <template v-slot:item.sat="{ item }">
                            <v-btn v-if="item.sat" fab x-small :color="(item.sat.selected?'blue lighten-3':(item.sat.current? 'blue lighten-5': 'white'))" elevation="0" @click="pickDate(item, 'sat')">{{ !item.sat.value ? '' : item.sat.value }}</v-btn>
                        </template>
                        <template v-slot:item.sun="{ item }">
                            <v-btn v-if="item.sun" fab x-small :color="(item.sun.selected?'blue lighten-3':(item.sun.current? 'blue lighten-5': 'white'))" elevation="0" @click="pickDate(item, 'sun')">{{ !item.sun.value ? '' : item.sun.value }}</v-btn>
                        </template>
                    </v-data-table>
                </v-row>
            </v-card-text>
        </v-card>
    </v-menu>
</template>
<script>
    export default {
        name:'s-date-range-picker',
        props: {
            label: String,
            value: {
                type: Array,
                default: () => ([]),
            }
        },
        data() {
            return {
                show : false,
                year: null,
                month:null,
                dayHeaders:[
                    {text: 'Sun', value: 'sun', width:36, sortable: false},
                    {text: 'Mon', value: 'mon', width:36, sortable: false},
                    {text: 'Tue', value: 'tue', width:36, sortable: false}, 
                    {text: 'Wed', value: 'wed', width:36, sortable: false}, 
                    {text: 'Thu', value: 'thu', width:36, sortable: false}, 
                    {text: 'Fri', value: 'fri', width:36, sortable: false}, 
                    {text: 'Sat', value: 'sat', width:36, sortable: false}
                ],
                months: [
                    {value:1,text:'January'},{value:2,text:'February'},{value:3,text:'March'},
                    {value:4,text:'April'},{value:5,text:'May'},{value:6,text:'June'},
                    {value:7,text:'July'},{value:8,text:'August'},{value:9,text:'September'},
                    {value:10,text:'October'},{value:11,text:'November'},{value:12,text:'December'}
                ],
                days: [],
                years: []
            }
        },
        computed: {
            dateRangeText() {
                if (this.value.length == 0) {
                    return '';
                }
                if (this.value.length == 1) {
                    return this.value[0];
                }
                if (this.value.length == 2) {
                    return this.value.sort().join('  至  ');
                }
            }
        },
        methods: {
            yearMonthChange(type, v) {
                let yc = 0;
                if (type == 'month') {
                    let tmpMonth = this.month + v;
                    if(tmpMonth <= 0 ) {
                        this.month = 12;
                        yc = -1;
                    } else if (tmpMonth > 12 ) {
                        this.month = 1;
                        yc = 1;
                    } else {
                        this.month = tmpMonth;
                        yc = 0;
                    }
                } else {
                    yc = v;
                }
                if (yc != 0) {
                    let tmpYear = this.year + v;
                    if (tmpYear < 2000) {
                        tmpYear = this.years[this.years.length];
                    } else if (tmpYear > this.years[this.years.length]) {
                        tmpYear = 2000;
                    }
                    this.year = tmpYear;
                }
                this.initDays(this.year, this.month, new Date(), this.value.sort());
            },
            yearChange(year) {
                this.initDays(this.year, this.month, new Date(), this.value.sort());
            },
            monthChange(month) {
                this.initDays(this.year, this.month, new Date(), this.value.sort());
            },
            pickDate(item, type) {
                if (this.value.length > 1) {
                    this.value.splice(0, 2);
                }
                let d = item[type].value;
                let selectedDate = this.year + '-' + (this.month < 10 ? '0' : '') + this.month + '-' + (d < 10 ? '0' : '' ) + d;
                this.$set(this.value, this.value.length, selectedDate);
                // 重新初始化日期表格
                this.initDays(this.year, this.month, new Date(), this.value.sort());
                if (this.value.length == 2) {
                    this.show = false;
                }
            },
            getMaxDate(year, month) {
                if (month == 1 || month == 3 || month == 5 || month == 7 || month == 8 || month == 10 || month == 12 ) {
                    return 31;
                }
                if (month == 4 || month == 6 || month == 9 || month == 11) {
                    return 30;
                }
                if ((year % 4 === 0 && year % 100 !== 0) || year % 400 === 0) {
                    return 29;
                }
                return 28;
            },
            initDays(year, month, currentDate, selectedDays) {
                // let nDays = new Array();
                let pDate = new Date(year, (month - 1), 1);
                let dayFixed = pDate.getDay() - 1;
                let day = {};
                let islastSat = false;
                let currentYear = currentDate.getFullYear();
                let currentMonth = (currentDate.getMonth() + 1);
                let currentDay = currentDate.getDate();
                
                let selectType = 0;
                let selectDate1 = '';
                let selectDate2 = '';
                if (selectedDays && selectedDays.length > 0) {
                    selectType = selectedDays.length;
                    selectDate1 = selectedDays[0];
                    if (selectedDays.length > 1 ) {
                        selectDate2 = selectedDays[1];
                    }
                }
                let maxDate = this.getMaxDate(year, month);
                this.days.splice(0);
                let index = 0;
                for(let i = 1; i <= maxDate; i++) {
                    islastSat = false;
                    let v = {value:i};
                    if (year == currentYear && month == currentMonth && i == currentDay) {
                       v.current = 1;
                    }
                    // 判断是否在选中区域
                    if (selectType == 1) {
                        let d = year + '-' + ( month < 10 ? '0' : '' ) + month + '-' + ( i < 10 ? '0' : '' ) + i;
                        v.selected = (d === selectDate1);
                    } else if (selectType == 2) {
                        let d = year + '-' + ( month < 10 ? '0' : '' ) + month + '-' + ( i < 10 ? '0' : '' ) + i;
                        if (d >= selectDate1 && d <= selectDate2) {
                            v.selected = 1;
                        }
                    }
                    let idx = (dayFixed + ( i % 7) + 7 ) % 7;
                    day[this.dayHeaders[idx].value] = v;
                    if (idx == 6) {
                        this.$set(this.days, index, day);
                        index = index + 1;
                        day = {};
                        islastSat = true;
                    }
                }
                if (!islastSat) {
                    this.$set(this.days, index, day);
                    index = index + 1;
                }
            },
            initYears(year) {
                // 2000 到 当前年后的 100年
                let lastYear = year + 50;
                for (let y = 2000; y <= lastYear; y++) {
                    this.years.push(y);
                }
            }
        },
        mounted() {
            let date = new Date();
            this.year = date.getFullYear();
            this.month = date.getMonth() + 1;
            this.initYears(date.getFullYear());
            this.initDays(this.year, this.month, date, []);
        }
    }
</script>