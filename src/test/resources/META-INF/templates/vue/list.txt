<template>
    <v-spacer></v-spacer>
    <v-layout>
        <v-container> 
            <v-row>[# th:unless="${#lists.isEmpty(columns)}"][# th:each="column : ${columns}"]
            [# th:if="${column.javaType == 'Date'}"][/]
            [# th:unless="${column.javaType == 'Date'}"]<v-col cols="1" sm="6" md="3" > <v-text-field v-model="searchForm._FC1_[(${#strings.substring(column.javaType,0,1)})]0_[(${column.property})]" label="[(${column.remark})]" outlined > </v-text-field> </v-col>[/]
            [/][/]
            </v-row> 
        </v-container> 
    </v-layout>
    <v-layout>
        <v-container>
            <v-row>
                <v-col cols="1" sm="6" md="1"><v-btn outlined color="primary" dark class="mb-2" @click="search">查找</v-btn></v-col>
                <v-col cols="1" sm="6" md="1"><v-btn outlined color="primary" dark class="mb-2" @click="clear">清除</v-btn></v-col>
                <v-col cols="1" sm="6" md="1"><v-btn outlined color="primary" dark class="mb-2" @click="create">新增</v-btn></v-col>
                <v-col cols="1" sm="6" md="1"><v-btn outlined color="primary" dark class="mb-2" @click="exportDatas">导出</v-btn><a href="#" hidden="true" style="display:none" id="downLoadFileHref" ref="downLoadFileHref"></a></v-col>
                <v-col cols="1" sm="6" md="1"><v-btn outlined color="primary" dark class="mb-2" @click="importData">导入</v-btn></v-col>
            </v-row>
        </v-container>
    </v-layout>
    <v-layout>
        <v-container>
            <v-data-table :headers="tableDatas.headers" :items="tableDatas.dataItems" :server-items-length="tableDatas.total" class="elevation-1"
                :footer-props="footOptions" :options.sync="pagination">
                <template v-slot:top>
                    <v-toolbar flat color="white" height="1px">
                        <v-dialog v-model="dialog" max-width="500px">
                            <v-card>
                                <v-card-title>
                                    <span class="headline">{{ formTitle }}</span>
                                </v-card-title>
                                <v-card-text>
                                    <v-container>
                                    [# th:unless="${#lists.isEmpty(columns)}"][# th:each="column : ${columns}"]
                                    <v-row>
                                        <v-col cols="1" sm="12" md="12">
                                            <template v-if="editAble">
                                                <v-text-field v-model="editedItem.[(${column.property})]" label="[(${column.remark})]" outlined></v-text-field>
                                            </template>
                                            <template v-else>
                                                <v-text-field v-model="editedItem.[(${column.property})]" label="[(${column.remark})]" outlined readOnly="true"></v-text-field>
                                            </template>
                                            </v-col>
                                    </v-row>
                                    [/][/]
                                    </v-container>
                                </v-card-text>
                                <v-card-actions>
                                    <v-spacer></v-spacer>
                                    <template v-if="editAble">
                                        <v-btn color="blue darken-1" text @click="close">取消</v-btn>
                                        <v-btn color="blue darken-1" text @click="save">保存</v-btn>
                                    </template>
                                    <template v-else>
                                        <v-btn color="blue darken-1" text @click="close">确定</v-btn>
                                    </template>
                                </v-card-actions>
                            </v-card>
                        </v-dialog>
                        <v-dialog v-model="deleteDialog" max-width="500px">
                            <v-card>
                                <v-card-title>
                                    <span class="headline">{{ deleteFormTitle }}</span>
                                </v-card-title>
                                <v-card-text> {{deleteMsg}} </v-card-text>
                                <v-card-actions>
                                    <v-spacer></v-spacer>
                                    <v-btn color="blue darken-1" text @click="cancelDelete">取消</v-btn>
                                    <v-btn color="blue darken-1" text @click="confirmDelete">删除</v-btn>
                                </v-card-actions>
                            </v-card>
                        </v-dialog>
                        <v-dialog v-model="confirmDialog" max-width="500px">
                            <v-card>
                                <v-card-title>
                                    <span class="headline">{{ confirmFormTitle }}</span>
                                </v-card-title>
                                <v-card-text> {{confirmMsg}} </v-card-text>
                                <v-card-actions>
                                    <v-spacer></v-spacer>
                                    <v-btn color="blue darken-1" text @click="colseConfirm">确定</v-btn>
                                </v-card-actions>
                            </v-card>
                        </v-dialog>
                        <v-dialog v-model="importDialog" max-width="500px">
                            <v-card>
                                <v-card-title>
                                    <span class="headline">导入</span>
                                </v-card-title>
                                <v-card-text>
                                    <v-file-input id="importFile" placeholder="请选择要上传的文件" outlined v-model="importFile"></v-file-input>
                                </v-card-text>
                                <v-card-actions>
                                    <v-spacer></v-spacer>
                                    <v-btn color="blue darken-1" text @click="importDatas">导入</v-btn>
                                    <v-btn color="blue darken-1" text @click="closeImport">取消</v-btn>
                                </v-card-actions>
                            </v-card>
                        </v-dialog>
                    </v-toolbar>
                </template>
                <template v-slot:item.actions="{ item }">
                    <v-icon class="mr-2" @click="viewItem(item)">mdi-text-box-outline</v-icon>
                    <v-icon class="mr-2" @click="editItem(item)">mdi-pencil</v-icon>
                    <v-icon class="mr-2" @click="deleteItem(item)">mdi-delete</v-icon>
                </template>
            </v-data-table>
        </v-container>
    </v-layout>
    </template>
    <script type="text/javascript" th:inline="javascript">
        new Vue({
            el: '#app',
            vuetify: new Vuetify(),
            data() {
                return {
                    dialog : false,
                    formTitle : "新增",
                    deleteDialog : false,
                    deleteFormTitle : "确认",
                    deleteMsg : "",
                    confirmDialog : false,
                    confirmFormTitle : "",
                    confirmMsg : "",
                    editAble : false,
                    importFile : null,
                    importDialog : false,
                    editedItem: {[# th:unless="${#lists.isEmpty(primaryColumns)}"][# th:each="column : ${primaryColumns}"]
                        [(${column.property})]:'',[/][/][# th:unless="${#lists.isEmpty(columns)}"][# th:each="column, st : ${columns}"]
                        [(${column.property})]:''[# th:if="${!st.last}"], [/][/][/]
                    },
                    searchForm: {[# th:unless="${#lists.isEmpty(columns)}"][# th:each="column, st : ${columns}"]
                        _FC1_[(${#strings.substring(column.javaType,0,1)})]0_[(${column.property})]:''[# th:if="${!st.last}"], [/][/][/]
                    },
                    footOptions: {
                        itemsPerPageOptions : [10,20,50]
                    },
                    pagination : {
                        itemsPerPage : 20,
                        page : 1,
                        sortBy : [],
                        sortDesc : [],
                        groupBy : [],
                        groupDesc : [],
                        mustSort : false,
                        multiSort : false
                    },
                    tableDatas: {
                        headers: [ [# th:unless="${#lists.isEmpty(primaryColumns)}"][# th:each="column : ${primaryColumns}"]
                            {text: '[(${column.remark})]', value: '[(${column.property})]', width:100, sortable: false},[/][/][# th:unless="${#lists.isEmpty(columns)}"][# th:each="column, st : ${columns}"]
                            {text: '[(${column.remark})]', value: '[(${column.property})]', width:100, sortable: false}[# th:if="${!st.last}"], [/]
                            [/][/]
                        ],
                        dataItems: [],
                        total : 0,
                        exportExclude : ['id', 'actions'],
                        exportFileName : "[(${modelName})]导出"
                    }
                }
            },
            watch: {
                pagination: {
                  handler () {
                      this.loadDatas();
                  },
                  deep: true,
                },
            },
            methods: {
                loadDatas() {
                    let _this = this;
                    common.searchDatas(/*[(${"[[@{/excel/list}]]"})]*/'/[(${mapping})]/list', _this.searchForm, _this.pagination, function(response){
                        let resp = response.data;
                        if(!resp.code && resp.data) {
                            _this.tableDatas.total = resp.data.total;
                            if(resp.data.total > 0) {
                                _this.tableDatas.dataItems = resp.data.datas;
                            } else {
                                _this.tableDatas.dataItems = [];
                            }
                        } else {
                            console.log(resp.msg);
                        }
                    }, function(error){
                        console.log(error);
                    });
                },
                search() {
                    this.loadDatas();
                },
                clear() {
                    let isDoClear = false;
                    for(let p in this.searchForm) {
                        if (this.searchForm[p] !== "") {
                            this.searchForm[p] = "";
                            isDoClear = true;
                        }
                    }
                    if(isDoClear) {
                        this.search();
                    }
                },
                create() {
                    this.editAble = true; 
                    this.formTitle = "新增";
                    this.editedItem = Object.assign({}, {[# th:unless="${#lists.isEmpty(primaryColumns)}"][# th:each="column : ${primaryColumns}"]
                        [(${column.property})]:'',[/][/][# th:unless="${#lists.isEmpty(columns)}"][# th:each="column, st : ${columns}"]
                        [(${column.property})]:''[# th:if="${!st.last}"], [/][/][/]
                    });
                    this.dialog = true;
                }, 
                viewItem (item) {
                    this.editAble = false;
                    this.formTitle = "查看";
                    this.editedItem = Object.assign({}, item);
                    this.dialog = true;
                },
                editItem (item) {
                    this.editAble = true;
                    this.formTitle = "编辑";
                    this.editedItem = Object.assign({}, item);
                    this.dialog = true;
                },
                deleteItem (item) {
                    this.editedItem = Object.assign({}, item);
                    this.deleteMsg = "确定要删除 " + item.name + "(" + item.email + ")";
                    this.deleteDialog = true;
                },
                close () {
                    this.dialog = false
                },
                confirmDelete() {
                    this.deleteData(this.editedItem);
                    this.deleteDialog = false;
                },
                cancelDelete() {
                    this.deleteDialog = false
                    this.editedItem = Object.assign({}, {[# th:unless="${#lists.isEmpty(primaryColumns)}"][# th:each="column : ${primaryColumns}"]
                        [(${column.property})]:'',[/][/][# th:unless="${#lists.isEmpty(columns)}"][# th:each="column, st : ${columns}"]
                        [(${column.property})]:''[# th:if="${!st.last}"], [/][/][/]
                    });
                },
                save () {
                    this.saveData(this.editedItem);
                    this.close();
                },
                colseConfirm() {
                    this.confirmDialog = false;
                },
                saveData(item) {
                    let _this = this;
                    let url = /*[(${#strings.concat("[[@{/", mapping ,"/save}]]")})]*/'/[(${mapping})]/save'; 
                    if (item.id) {
                        url = /*[(${#strings.concat("[[@{/", mapping ,"/update}]]")})]*/'/[(${mapping})]/update'; 
                    }
                    common.updateData(url, item, function(response){
                        let resp = response.data;
                        if(resp.success && resp.data) {
                            _this.confirmFormTitle = "成功";
                            _this.confirmMsg = "保存成功";
                        } else {
                            _this.confirmFormTitle = "失败";
                            _this.confirmMsg = "保存失败";
                        }
                        _this.confirmDialog = true;
                    }, function(error){
                        _this.confirmFormTitle = "失败";
                        _this.confirmMsg = "异常:" + error;
                        _this.confirmDialog = true;
                    });
                },
                deleteData(item) {
                    let _this = this;
                    common.updateData(/*[(${#strings.concat("[[@{/", mapping ,"/delete}]]")})]*/'/[(${mapping})]/delete', item, function(response){
                        let resp = response.data;
                        if(resp.success && resp.data) {
                            _this.confirmFormTitle = "成功";
                            _this.confirmMsg = "删除成功";
                        } else {
                            _this.confirmFormTitle = "失败";
                            _this.confirmMsg = "删除失败";
                        }
                        _this.confirmDialog = true;
                    }, function(error){
                        _this.confirmFormTitle = "失败";
                        _this.confirmMsg = "异常:" + error;
                        _this.confirmDialog = true;
                    });
                },
                exportDatas() {
                    let _this = this;
                    common.exportDatas(/*[(${#strings.concat("[[@{/", mapping ,"/export}]]")})]*/'/[(${mapping})]/export', _this.searchForm, _this.exportFileName, _this.tableDatas.headers, function(error){
                        _this.confirmFormTitle = "失败";
                        _this.confirmMsg = "异常:" + error;
                        _this.confirmDialog = true;
                    });
                },
                importData () {
                    this.importFile = null;
                    this.importDialog = true;
                },
                importDatas () {
                    let _this = this;
                    common.importDatas(/*[(${#strings.concat("[[@{/", mapping ,"/import}]]")})]*/'/[(${mapping})]/import', _this.importFile, 
                    "[# th:unless="${#lists.isEmpty(primaryColumns)}"][# th:each="column : ${primaryColumns}"][(${column.property})],[/][/][# th:unless="${#lists.isEmpty(columns)}"][# th:each="column, st : ${columns}"][(${column.property})][# th:if="${!st.last}"],[/][/][/]", 
                    function(response){
                        let resp = response.data;
                        if(resp.success && resp.data) {
                            _this.confirmFormTitle = "成功";
                            _this.confirmMsg = "导入成功";
                        } else {
                            _this.confirmFormTitle = "失败";
                            _this.confirmMsg = "导入失败," + resp.errorMsg;
                        }
                        _this.closeImport();
                        _this.confirmDialog = true;
                    }, 
                    function(error){
                        _this.confirmFormTitle = "失败";
                        _this.confirmMsg = "异常:" + error;
                        _this.closeImport();
                        _this.confirmDialog = true;
                    });
                },
                closeImport() {
                    this.importDialog = false;
                    this.importFile = null;
                }
            }
        });
    </script>